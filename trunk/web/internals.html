<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
  <title>ForceDel - Delte files that are in use</title>
  <style type="text/css" media="screen">@import url(style.css);</style>
</head>
<body>

  <div id="thebox">
    <div id="logo"><strong>ForceDel</strong></div>
    <div id="nav">
      <ul>
        <li><a href="index.html">Home</a></li>
	      <li><a href="about.html">About</a></li>
	      <li><a href="internals.html">Internals</a></li>
	      <li><a href="download.html">Download</a></li>
	      <li><a href="links.html">Links</a></li>
	      <li><a href="contact.html">Contact</a></li>
      </ul>
    </div>
    
    <div id="content">
 
    <h1>How does it work</h1>
	  <p>
      Well, it is quite easy: ForceDel determines witch processes are holding locks on the file and then closes the file so it can be deleted. Easy, eh?
      <br /><br />
      NO, IT IS NOT!
      <br /><br />
      The first thing ForceDel has to do is to determine wich process(es) have the file opened or locked. On Windows Vista (and newer) there is a
      new <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/cc948910%28v=vs.85%29.aspx">Restart Manager API</a> that can be used to get
      this information easily. On Windows XP you have to use the badly documented Windows function
      <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724509%28v=vs.85%29.aspx">NtQuerySystemInformation</a> to get all currently
      running processes with their opened files (file handles).
      <br /><br />
      Now that ForceDel knows the processes and the handles, the next challenge is to get the file name from every file handle. This can be done with
      the Windows function <a href="http://msdn.microsoft.com/en-us/library/bb432383%28v=vs.85%29.aspx">NtQueryObject</a>.
      But pay attention - this function will block for various handle types (i. e. for named pipes). To bypass this incredible blocking feature, ForceDel
      issues this function in a thread - if the thread is not able to get the filename within a specified time, ForceDel skips
      this handle and continues with the next one. So some file handles are skipped/ignored - but ForceDel will not block forever.
      <br /><br />
      When ForceDel got the right handle (a handle for the file to be deleted), ForceDel uses a special feature of the Windows API. The function
      <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms724251%28v=vs.85%29.aspx">DuplicateHandle</a> is used to make a copy of the
      file handle - but in a way that the file handle is not just copied, it is also closed in the process
      that has the file open. Then ForceDel closes the file too and deletes is. Thats it!
      <br /><br />
      Over 500 lines of code just to delete a file...
    </p>
    </div>
  </div>
  
  <br /><br />
  
  <div id="foot"><a href="http://validator.w3.org/check?uri=referer" target="_blank">Valid
    XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" target="_blank">Valid
    CSS</a> | Copyright © Michael Knigge | Design by <a href="http://smallpark.org">SmallPark</a>
  </div>
  
</body>
</html>
